# まじん式プロンプト v3 コード置き換えポイント

## 1. SlideData の入力方式（埋め込み型 → JSON）
- **従来 (v2)**: Apps Script 内に `const slideData = [...]` として配列を直接埋め込み。
- **v3**: AI が JSON 文字列のみを出力し、スクリプトがそれを `JSON.parse` で読み込む方式に変更。
- **修正箇所**: 固定の `slideData` 定義を削除し、JSON 文字列を入力・パースする関数を追加。
- **理由**: 出力サイズを大幅に削減（約95k文字 → 15k文字）し、Gemini 無料枠でも処理可能にするため 。
- **修正方針**: JSON を受け取り `createPresentation(slideDataObj)` に渡す仕組みを導入。コード内の `slideData` 依存部分を置き換える。

## 2. スライドパターンの追加対応
- **従来 (v2)**: 約19種類のパターンに対応。
- **v3**: 新たに `statsCompare`, `hybridContent`, `compareCards`, `contentProgress`, `timelineCards`, `iconCards`, `roadmapTimeline` など 9種を追加（全28種類）【36†L592-L600】【37†L91-L99】。
- **修正箇所**: `slideGenerators` の分岐に新しいパターンを追加。各 `createXXXSlide` 関数を実装。
- **理由**: 新しいレイアウトに対応しないと v3 が出力するスライドを生成できないため。
- **修正方針**: v3 のコードから各関数を移植。既存の switch/dispatcher に登録。

## 3. スピーカーノートの統合
- **従来 (v2)**: スピーカーノート未対応。
- **v3**: 各スライドに `data.notes` を出力。スピーカーノート欄へ自動書き込み【32†L405-L413】。
- **修正箇所**: スライド生成後に以下を追加：
  ```js
  if (data.notes) {
      const notesShape = slide.getNotesPage().getSpeakerNotesShape();
      if (notesShape) notesShape.getText().setText(data.notes);
  }
  ```
- **理由**: 発表者原稿を自動生成するため。
- **修正方針**: 各スライド生成処理の末尾にこの処理を追加。

## 4. カスタム設定メニューとプロパティ
- **従来 (v2)**: 固定色・固定フォント。コードを編集しないと変更不可。
- **v3**: 「カスタム設定」メニューを Slides UI に追加。色・フォント・フッター文・ロゴを UI から変更可能【32†L427-L436】。
- **修正箇所**:
  - `onOpen` でカスタムメニューを作成。
  - `setPrimaryColor`, `setFont`, `setFooterText`, `setHeaderLogo`, `setClosingLogo` などを実装【32†L443-L451】。
  - `PropertiesService.getScriptProperties()` で値を保存・読み込み。
- **理由**: ユーザーがブランドカラーやロゴを反映できるようにするため。
- **修正方針**: v3 のサンプルコードを統合。スライド生成時に `CONFIG` をユーザー設定で上書き。

## 5. デザイントークンとダークモード対応準備
- **従来 (v2)**: 色やサイズをコード内に直接記述。
- **v3**: `CONFIG.COLORS`, `CONFIG.FONTS` などにトークン化。色調整関数（`adjustColorBrightness` など）を追加【38†L1937-L1945】。
- **修正箇所**: ハードコード値をトークン参照に置き換え。新しいユーティリティ関数を追加。
- **理由**: デザインの一貫性を保ち、将来のダークモード実装を容易にするため。
- **修正方針**: v3 の `CONFIG` とユーティリティを導入。フォント・色指定をトークンベースに統一。

## 6. 安定性とエラーハンドリング
- **従来 (v2)**: 1スライドでエラーが出ると全体が停止。
- **v3**: `try/catch` でスライド単位にエラー処理し、残りは続行【32†L415-L423】。
- **修正箇所**: スライド生成ループに `try/catch` を追加。
- **理由**: 一部失敗しても全体生成を継続するため。
- **修正方針**: 例外時に `Logger.log` で記録し、次のスライドに進む仕組みを導入。

---

## まとめ
v3 への移行には以下の変更が必須：
1. JSON 入力方式への置き換え
2. 新パターンの追加実装
3. スピーカーノート出力
4. カスタム設定メニュー導入
5. デザイントークン統合
6. スライド単位のエラーハンドリング

これらにより **v3 と同等の機能・安定性・デザイン** を実現し、Google スライド自動生成を安心して運用できる。

