# ダークモード切替改善 修正案

## 背景
- 現状のダークモード切替は `CONFIG.COLORS` の再設定と新規生成スライドへの適用のみを行っています。
- 既に生成済みのスライドはそのまま残り、背景色やテキスト色がライトテーマのままになってしまいます。
- プレゼン資料をそのまま利用しながらテーマを切り替えたい、という要件を満たしていません。

## 課題
- ダークモードに切り替えても、既存スライド・図形・テキストの色が更新されない。
- スライドごとにテーマカラーを調整する仕組みがなく、一括での更新も困難。

## 原因
- `toggleTheme()` が `CONFIG.COLORS` を更新するのみで、スライド上の色プロパティを書き換えていない。
- 生成済み要素はそれぞれ個別に色を保持しているため、`CONFIG` の変更では反映されない。

## 修正方針
1. テーマ切替時に現在開いているプレゼンテーションを走査し、既存要素の色を新テーマへマッピングする。
2. 既存要素がライトテーマのどのカラーを使っているかを特定し、対応するダークテーマカラーへ置換。
3. プライマリカラーから派生して明度を調整した色については、明度比を推定してダークテーマのプライマリカラーへ再適用。

## 実装概要
- `darkMode.js:1` でテーマ定義・切替ロジックを分離。
- `darkMode.js:78` `toggleTheme()` からテーマ刷新処理 `refreshPresentationTheme()` を呼び出す。
- `darkMode.js:101` `refreshPresentationTheme()` にてプレゼン全スライドを走査し、背景・図形・テキストを更新。
  - `buildThemeColorIndex()` (`darkMode.js:118`) でライトテーマの色情報をキー化。
  - `updateSlideElements()` (`darkMode.js:139`) で各ページ要素を再帰的に処理。
  - `refreshShapeElement()` (`darkMode.js:150`) / `refreshTableElement()` (`darkMode.js:166`) で図形/表の塗りと文字色を調整。
  - `applyThemeToTextRange()` (`darkMode.js:186`) と `applyThemeToSingleTextRange()` (`darkMode.js:196`) でテキストスタイルの色を更新。
  - `transformDerivedColor()` (`darkMode.js:214`) でプライマリカラーに対する明度比を推定し、ダークテーマのプライマリ色へ変換。
- `inferBrightnessFactor()` (`darkMode.js:223`) と `isWithinColorTolerance()` (`darkMode.js:239`) で派生色の精度を担保。

## 影響範囲
- ダークモード切替操作時のみ追加でプレゼン全体を走査するため、スライド数が多い場合は数秒の処理時間増加が見込まれる。
- 塗りがグラデーション・画像の図形には影響しない（固体塗りのみ対象）。
- 特殊な色（ユーザが独自に設定した色）はライトテーマに由来しない限り変換対象外。

## リスクと緩和策
- **マッピング漏れ**: 派生色推定がうまく当たらない場合に色が変わらない可能性 → ログ (`logError`) を出力済み、必要に応じて追加色定義で対応。
- **性能**: 大規模スライドの場合に遅延 → `logInfo('refreshPresentationTheme:completed', ...)` で処理完了をログ出力し、必要ならば進捗通知を検討。

## テスト計画
1. ライトテーマでスライド生成 → `toggleTheme()` を実行し、既存スライドの背景/文字色がダークテーマへ更新されることを確認。
2. ダークテーマからライトテーマへ戻して同様に色が戻るかを確認。
3. プライマリカラーをカスタム設定してからダーク/ライト切替を実施し、派生色が一貫して変換されるかを確認。
4. 表・グループ化した図形など複数要素を含むスライドで正常に更新されるか確認。

## 今後の拡張
- グラデーションや画像塗りへの変換対応（必要であれば別タスク化）。
- タイムアウトを避けるため、必要ならばスライド数が多いケース向けにバッチ処理や進捗表示を追加検討。
