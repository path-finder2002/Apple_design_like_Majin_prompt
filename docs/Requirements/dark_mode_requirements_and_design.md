# ダークモード要件定義・設計書

## 1. 背景
- 現状のダークモード切り替えは、新規スライドにしか適用されない。
- 既存スライドのテーマ（背景色、テキスト色など）は変更されず、ライトテーマのまま残ってしまう。
- プレゼンテーション全体で一貫したテーマを提供できていない。

## 2. 目的
- ライトモードとダークモードをいつでも切り替え可能にし、プレゼンテーション全体のテーマを一括で更新する機能を提供する。
- 既存の全スライド、図形、テキストの色を、選択したテーマ（ライト/ダーク）に準拠した色へ自動的に置換する。
- AppleのHIG（ヒューマンインターフェイスガイドライン）に準拠した、高品質なダークモード体験を実現する。

## 3. スコープ
### 対象
- スライドの背景色
- 図形（Shape）の塗りつぶし色と枠線の色（単色塗りのみ）
- テキスト（TextRange）の色
- 表（Table）のセルの背景色、枠線の色、テキストの色

### 対象外
- グラデーション、画像、動画などの塗りつぶし
- ユーザーが手動で設定した、テーマカラーパレット以外の色
- 埋め込みオブジェクト（グラフ、図など）の内部カラー

## 4. 機能要件
| ID | 要件 | 詳細 |
|---|---|---|
| FR-DM-01 | テーマ切り替え機能 | UI（メニューやダイアログ）から、ライトテーマとダークテーマを切り替えることができる。切り替えを実行すると、現在開いているプレゼンテーションの全ての要素が、新しいテーマの色に更新される。 |
| FR-DM-02 | カラーマッピング | ライトテーマのカラーパレットと、それに対応するダークテーマのカラーパレットを定義する。テーマ切り替え時、既存要素の色がライトテーマのどの色かを特定し、対応するダークテーマの色に置換する。 |
| FR-DM-03 | 派生色の変換 | テーマのプライマリカラーから明度調整によって派生した色（例：プライマリカラーを少し明るくした色）も、正しく変換する。元のプライマリカラーに対する明度の比率を計算し、新しいテーマのプライマリカラーにその比率を適用して新しい派生色を生成する。 |
| FR-DM-04 | アクセシビリティ | ダークモードの配色は、WCAG 2.1のコントラスト比AAレベル（4.5:1）以上を維持する。特に、テキストと背景色のコントラストに注意する。 |

## 5. 非機能要件
| ID | 要件 | 詳細 |
|---|---|---|
| NFR-DM-01 | パフォーマンス | テーマ切り替え処理は、スライド枚数が100枚程度の場合でも、妥当な時間（例: 10秒以内）で完了すること。処理時間が長くなる場合は、プログレスバーなどでユーザーに進捗を通知することを検討する。 |
| NFR-DM-02 | メンテナンス性 | カラーパレットやテーマの定義は、`CONFIG`オブジェクトのような設定ファイルに集約し、容易に変更・拡張できるようにする。テーマ変換ロジックはモジュール化し、再利用性と可読性を高める。 |
| NFR-DM-03 | 堅牢性 | 色の変換に失敗した場合（マッピング対象外の色など）でも、スクリプトが停止しないこと。エラーや変換できなかった要素については、ログに記録する。 |

## 6. 設計方針
`dark_mode_theme_refresh_proposal.md` の実装概要を踏襲する。

### テーマ定義
- `CONFIG.THEMES` のようなオブジェクトに、`light` と `dark` のテーマを定義する。
- 各テーマには、`primary`, `secondary`, `background`, `text`, `accent` などのキーでカラーコードを定義する。
```javascript
const CONFIG = {
  THEMES: {
    light: {
      primary: '#FFFFFF',
      text: '#000000',
      background: '#F5F5F7',
      accent: '#0A84FF',
      // ... other colors
    },
    dark: {
      primary: '#1D1D1F',
      text: '#FFFFFF',
      background: '#000000',
      accent: '#3EDDFF',
      // ... other colors
    }
  }
};
```

### テーマ切り替え処理 (`toggleTheme`)
1. 現在のテーマ（ライト/ダーク）を判定する。
2. 切り替え先のテーマを決定する。
3. `refreshPresentationTheme(newTheme)` を呼び出す。
4. スクリプトプロパティに現在のテーマを保存する。

### テーマ刷新処理 (`refreshPresentationTheme`)
1. `getActivePresentation()` で現在のプレゼンテーションを取得する。
2. `getSlides()` で全スライドを取得する。
3. `buildThemeColorIndex(oldTheme)` を実行し、旧テーマの色の逆引きマップを作成する。（例: `{'#FFFFFF': 'primary', '#000000': 'text'}`）
4. 各スライドをループし、`updateSlideElements(slide, oldTheme, newTheme, colorIndex)` を実行する。

### 要素更新処理 (`updateSlideElements`)
1. スライドの背景色を `newTheme.background` に更新する。
2. `getPageElements()` でスライド上の全要素を取得する。
3. 各要素（`Shape`, `Table` など）を再帰的に処理し、それぞれの更新関数（`refreshShapeElement`, `refreshTableElement`）を呼び出す。

### 個別要素の更新処理
- **`refreshShapeElement`**:
  - `getFill()` で塗りつぶし色を取得する。
  - `getForegroundColor()` でテキスト色を取得する。
  - 取得した色を `colorIndex` や `transformDerivedColor` を使って新しいテーマの色に変換し、`getFill().setSolidFill()` や `getText().getTextStyle().setForegroundColor()` で更新する。
- **`refreshTableElement`**:
  - 各セルをループし、`getFill()` や `getText()` で色を取得・更新する。

### 派生色の変換処理 (`transformDerivedColor`)
- `inferBrightnessFactor` を使用して、元のプライマリカラーからの明度の差を計算する。
- 新しいテーマのプライマリカラーにその差を適用して、新しい色を返す。
- `isWithinColorTolerance` を使用して、色がプライマリカラーの派生であるかを判定する。

## 7. テスト計画
`dark_mode_theme_refresh_proposal.md` のテスト計画に準拠する。
- ライトテーマで作成したスライドが、ダークテーマに正しく変換されることを確認する。
- ダークテーマからライトテーマに戻ることも確認する。
- プライマリカラーを変更した場合でも、派生色が正しく変換されることを確認する。
- 表やグループ化された図形を含む複雑なスライドで、すべての要素が正しく更新されることを確認する。
- 変換対象外の色が変更されないことを確認する。
